---
title: "session 3 notes"
author: "Tim Riffe"
date: "2025-07-09"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# usage of new lifetable function, `lt_full()`

To load, you can source straight from github like so:
```{r}
library(tidyverse)
library(janitor)
source("https://raw.githubusercontent.com/timriffe/BSSD2025Module2/refs/heads/master/02_lifetables.R")
```

To use, you need to group your data
```{r}
D <- read_csv("https://github.com/timriffe/BSSD2025Module2/raw/refs/heads/master/data/ES_mort.csv.gz",show_col_types = FALSE) |> 
  clean_names()

D |> 
  mutate(mx = if_else(is.na(mx) | mx == 0, .5, mx)) |> 
  filter(sex != "total") |> 
  group_by(year, sex) |> 
  group_modify(~lt_full(data= .x, groups = .y))
```


# calculate all WPP lifetables:

load it:
```{r}
wpp <- 
  read_csv("https://github.com/timriffe/BSSD2025Module2/raw/refs/heads/master/data/mxwpp.csv.gz", show_col_types = FALSE)
```

Now calculate lifetable for each subset (year, sex, location)

```{r, eval = FALSE}
wpp_lt <-
  wpp |> 
  mutate(sex = if_else(sex == "m","male","female")) |> 
  group_by(un_code, year, sex) |> 
  reframe(lt_full2(age = age, 
                   mx = mx, 
                   sex = sex,
                   radix = 1e5))
```

# 

In a move of pure desperation, I copied the function guts of `lt_full()` into a pure `mutate()`. Let's not rule out that I have an old machine as being the primary cause of this awkward delay.

```{r}
wpp_lt <-
  wpp |> 
  mutate(sex = if_else(sex == "m","male","female")) |> 
  group_by(un_code, year, sex) |> 
  mutate(
      # new use nx
      nx = c(diff(age),1),
      ax = mx_to_ax(mx = mx, 
                    sex = sex[1], 
                    age = age,
                    nx = nx),
      qx = calc_qx(mx = mx, 
                   ax = ax, 
                   age = age,
                   nx = nx),
      lx = calc_lx(qx = qx, radix = 1e5),
      dx = lx * qx,
      Lx = calc_Lx(lx = lx,
                   ax = ax,
                   dx = dx,
                   nx = nx),
      Tx = calc_Tx(Lx),
      ex = Tx / lx) |> 
  ungroup()
```


#

```{r}
#install.packages("countrycode")
library(countrycode)
wpp_iso <-
  wpp_lt |> 
  mutate(iso = countrycode(sourcevar = un_code, 
            origin = "un", 
            destination = "iso3c")) |> 
  filter(!is.na(iso)) 

```
```{r}
wpp_iso |> 
  filter(year < 2023,
         year %% 10 == 0) |> 
  ggplot(aes(x = age, y = mx, group = interaction(year,iso))) +
  geom_line(alpha = .05) +
  scale_y_log10() +
  facet_wrap(~sex)
```

# 

1. use `countrycode` package to add a column for `continent`
2. create a column called `decade`.
```{r}
year <- 1950:2020
decade <- year - year %% 10
```
3. use this helper function to estimate a slope of increase in life expectancy at birth, for each decade and continent. Tip: use `summarize()`
```{r}
slope_helper <- function(year, e0){
  coefs <- lm(e0~year) |> coef()
  coefs["year"]
}
```
4. display result as a table with decades in columns and continents in rows

```{r}
wpp_iso |> 
  mutate(continent = countrycode(iso, 
                                 origin = "iso3c", 
                                 destination = "continent"),
         decade = year - year %% 10) |> 
  filter(age == 0, year < 2020) |> 
  group_by(decade, continent) |> 
  summarize(pace = slope_helper(year = year, e0 = ex),
            .groups = "drop") |> 
  mutate(pace = round(pace,2)) |> 
  pivot_wider(names_from = decade, values_from = pace)
```

















